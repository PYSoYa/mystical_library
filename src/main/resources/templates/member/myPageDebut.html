<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>신비한 서재입니다.</title>

  <link rel="apple-touch-icon" sizes="180x180" th:href="@{/icon/apple-touch-icon.png}">
  <link rel="icon" type="image/png" sizes="32x32" th:href="@{/icon/favicon-32x32.png}">
  <link rel="icon" type="image/png" sizes="16x16" th:href="@{/icon/favicon-16x16.png}">
  <link rel="manifest" th:href="@{/icon/site.webmanifest}">

  <link rel="stylesheet" th:href="@{/css/member/myPage.css}">
</head>
<body>
<th:block th:replace="layout/header :: header"></th:block>

<main class="main-container">
  <div class="profile-container">
    <div class="profile-detail-container">
      <div class="profile-detail-wrap">
        <div class="profile-image-wrap">
          <img th:src="@{|/upload/${member.memberImgName}|}" class="image" alt="">
        </div>
        <div class="profile-author-wrap">
          <h5 class="author" th:text="${member.memberName}"></h5>
        </div>
        <div class="profile-intro-wrap">
          <span class="intro" th:text="${member.introduction}"></span>
        </div>
        <div class="profile-sns-btn-wrap">
          <div class="instagram">
            <a href="https://www.instagram.com" th:if="${member.instagramAddress != null}">
              <svg xmlns="http://www.w3.org/2000/svg" width="2rem" height="2rem" fill="currentColor" class="bi bi-instagram" viewBox="0 0 16 16">
                <path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.911 3.911 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599.28.28.453.546.598.92.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.47 2.47 0 0 1-.599.919c-.28.28-.546.453-.92.598-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.478 2.478 0 0 1-.92-.598 2.48 2.48 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233 0-2.136.008-2.388.046-3.231.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045v.002zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334z"/>
              </svg>
            </a>
          </div>
          <div class="twitter">
            <a href="https://twitter.com" th:if="${member.twitterAddress != null}">
              <svg xmlns="http://www.w3.org/2000/svg" width="2rem" height="2rem" fill="currentColor" class="bi bi-twitter" viewBox="0 0 16 16">
                <path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z"/>
              </svg>
            </a>
          </div>
          <div class="facebook">
            <a href="https://www.facebook.com" th:if="${member.facebookAddress != null}">
              <svg xmlns="http://www.w3.org/2000/svg" width="2rem" height="2rem" fill="currentColor" class="bi bi-facebook" viewBox="0 0 16 16">
                <path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951z"/>
              </svg>
            </a>
          </div>
        </div>
        <div class="profile-heart-wrap">
          <div id="loveChange1" class="heart" sec:authorize="isAuthenticated()" th:if="${wishlist.size() == 0}">
            <a th:onclick="love()">
              <svg xmlns="http://www.w3.org/2000/svg" width="3rem" height="3rem" fill="currentColor" class="bi bi-heart empty-heart" viewBox="0 0 16 16">
                <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z"/>
              </svg>
            </a>
          </div>
          <div id="loveChange2" class="heart" sec:authorize="isAuthenticated()" th:if="${wishlist.size() != 0}">
            <a th:onclick="love()">
              <svg xmlns="http://www.w3.org/2000/svg" width="3rem" height="3rem" fill="currentColor" class="bi bi-heart-fill full-heart" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"/>
              </svg>
            </a>
          </div>
        </div>
        <div class="profile-heart-detail-wrap">
          <span class="detail" th:text="${wishCount}+'명이 좋아해요'" th:if="${wishCount ne 0}"></span>
        </div>
        <div sec:authorize="isAuthenticated()" th:if="${member.id.equals(authentication.id)}" class="edit-btn-wrap">
          <span id="memberIdForUpdate" th:text="${member.id}" hidden></span>
          <button type="button" onclick="reqUpdate()">정보수정</button>
        </div>
      </div>
      <div class="profile-nav-container">
        <div class="profile-nav">
          <div class="nav-item">
            <a th:href="@{|/member/myPage/${member.id}|}">연재 작품</a>
          </div>
          <div class="nav-item">
            <a th:href="@{|/member/myPage/${member.id}/completion|}">완결 작품</a>
          </div>
          <div class="nav-item selected-item">
            <a th:href="@{|/member/myPage/${member.id}/debut|}">데뷔 글</a>
          </div>
          <div class="nav-item">
            <a th:href="@{|/member/myPage/${member.id}/waiting|}">승인 대기 중</a>
          </div>
        </div>
      </div>

      <div th:each="debutList:${myDebutList}" class="post-list-container">
        <div class="post-container">
          <div class="img-wrap">
            <a th:href="@{|/debut/detail/${debutList.id}/|}">
              <img th:src="@{|/upload/${debutList.debutImgName}|}" class="img" alt="">
            </a>
          </div>
          <div class="detail-wrap">
            <div class="title-wrap">
              <span class="title" th:text="${debutList.debutTitle}"></span>
            </div>
            <div class="author-wrap">
              <a th:href="@{|/member/myPage/${debutList.memberId}|}" class="author-link">
                <span class="author" th:text="${debutList.memberName}">작가</span>
              </a>
              <svg xmlns="http://www.w3.org/2000/svg" width="1.2rem" height="1.2rem" fill="currentColor" class="bi bi-eye eye-icon" viewBox="0 0 16 16">
                <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
              </svg>
              <span class="hits" th:text="${debutList.debutHits}"></span>
              <svg xmlns="http://www.w3.org/2000/svg" width="1.2rem" height="1.2rem" fill="currentColor" class="bi bi-heart-fill full-heart debut-heart heart-icon" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"/>
              </svg>
              <span class="heart" th:text="${debutList.love}"></span>
            </div>
            <div class="intro-wrap">
              <span class="intro" th:text="${debutList.introduce}"></span>
            </div>
            <div class="tag-wrap">
              <span class="tag novel" th:if="${debutList.categoryId eq 1}">웹소설</span>
              <span class="tag poem" th:if="${debutList.categoryId eq 2}">시</span>
              <span class="tag essay" th:if="${debutList.categoryId eq 3}">에세이</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<th:block th:replace="layout/footer :: footer"></th:block>
</body>
<script th:inline="javascript">
  const love = () => {
      if ([[${authentication}]] != null) {
          const memberId = [[${member.id}]];
          const memberName = [[${authentication.memberName}]];

          let header = $("meta[name='_csrf_header']").attr('content');
          let token = $("meta[name='_csrf']").attr('content');

          $.ajax({
              type: "post",
              url: "/wish/check",
              data: {
                  "memberId": memberId,
                  "memberName": memberName
              },
              dataType: "text",
              beforeSend: function(xhr){
                  xhr.setRequestHeader(header, token);
              },
              success: function (result) {
                  if (result === "ok") {
                      $.ajax({
                          type: "delete",
                          url: "/wish/delete",
                          data: {
                              "memberId" : memberId,
                              "memberName" : memberName
                          },
                          dataType: "text",
                          beforeSend: function(xhr){
                              xhr.setRequestHeader(header, token);
                          },
                          success: function (result) {
                              const loveChange1 = document.getElementById("loveChange1");
                              if (result == "ok"){
                                  Swal.fire({
                                      icon: 'success',
                                      text: '관심 목록에서 삭제했어요.',
                                      showConfirmButton: false,
                                      timer: 1500
                                  });
                                  setTimeout(function (){
                                      location.reload();
                                  },1000);
                              } else {
                                  alert("실패");
                              }
                          }
                      })
                  } else {
                      $.ajax({
                          type: "post",
                          url: "/wish/save-writer",
                          data: {
                              "memberId": memberId,
                              "memberName": memberName
                          },
                          dataType: "text",
                          beforeSend: function(xhr){
                              xhr.setRequestHeader(header, token);
                          },
                          success: function (result) {
                              const loveChange2 = document.getElementById("loveChange2");
                              if (result == "ok") {
                                  Swal.fire({
                                      icon: 'success',
                                      text: '관심 목록에 해당 작가를 등록했어요.',
                                      showConfirmButton: false,
                                      timer: 1500
                                  });
                                  setTimeout(function (){
                                      location.reload();
                                  },1000);
                              } else {
                                  alert("실패");
                              }

                          },

                      })
                  }
              }
          })
      }
  }

  const reqUpdate = () => {
    let header = $("meta[name='_csrf_header']").attr('content');
    let token = $("meta[name='_csrf']").attr('content');

    const id = document.getElementById('memberIdForUpdate').innerHTML;
    const loginId = [[${member.loginId}]];

    // 비밀번호 입력 후 이동 해야 함

    Swal.fire({
      title: '비밀번호를 입력해주세요.',
      input: 'password',
      inputAttributes: {autocapitalize: 'off'},
      showCancelButton: true,
      confirmButtonText: '확인',
      cancelButtonText: '취소',
      showLoaderOnConfirm: true,
      preConfirm: (pw) => {
        $.ajax({
          type: 'post',
          url: '/member/check-password',
          data: {"loginId" : loginId, "memberPassword" : pw},
          dataType: 'text',
          beforeSend: function(xhr){
            xhr.setRequestHeader(header, token);
          },
          success: function (result) {
            if (result !== 'no') {
              Swal.fire({
                icon: 'success',
                title: '비밀번호가 일치해요.',
                showConfirmButton: false,
                timer: 1500
              });
              setTimeout( () => {location.href = '/member/update-form/' + id}, 2000)
            } else {
              Swal.fire({
                icon: 'error',
                title: '비밀번호가 달라요.'
              })
            }
          },
          err: function () {
            alert('에러, 관리자에게 문의하세요.');
          }
        });
      }
    });
  }
</script>
</html>